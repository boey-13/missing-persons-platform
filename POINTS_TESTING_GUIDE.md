# 🎯 积分系统测试指南

## 📋 测试概述

本指南将帮助你手动测试FindMe平台的积分系统，确保所有用户行为都能正确获得积分。

## 🚀 快速测试命令

运行以下命令进行自动化测试：

### 积分系统测试
```bash
php artisan test:points-system
```

### 社交分享功能测试
```bash
php artisan test:social-share
```

### 志愿者申请功能测试
```bash
php artisan test:volunteer-application
```

### 全功能综合测试
```bash
php artisan test:all-features
```

这些命令会自动创建测试用户，执行各种操作，并验证积分系统是否正常工作。

## 📝 手动测试步骤

### 1. 用户注册积分测试

**测试目标**: 验证新用户注册时获得10积分

**步骤**:
1. 访问 `/register` 页面
2. 填写注册信息并提交
3. 登录后访问 `/profile` 页面
4. 检查积分余额是否为10分

**预期结果**: ✅ 新用户获得10积分

---

### 2. 目击报告积分测试

**测试目标**: 验证提交目击报告时获得10积分

**步骤**:
1. 登录用户账户
2. 访问任意失踪人员详情页面
3. 点击"Report Sighting"按钮
4. 填写目击报告并提交
5. 以管理员身份登录，将目击报告状态改为"Approved"
6. 检查用户积分是否增加10分

**预期结果**: ✅ 目击报告被批准后获得10积分

---

### 3. 社区项目积分测试

**测试目标**: 验证完成社区项目时获得项目设定的积分奖励

**步骤**:
1. 以管理员身份创建社区项目，设置积分奖励（如50分）
2. 以志愿者身份申请该项目
3. 管理员批准志愿者申请
4. 管理员将项目状态改为"Completed"
5. 检查志愿者积分是否增加50分

**预期结果**: ✅ 项目完成后获得设定的积分奖励

---

### 3.1. 志愿者申请测试

**测试目标**: 验证志愿者申请功能正常工作

**步骤**:
1. 登录用户账户
2. 访问 `/volunteer/apply` 页面
3. 填写完整的志愿者申请表单：
   - 动机（必填，至少10字符）
   - 技能和语言（可选）
   - 可用时间（可选）
   - 首选角色（可选）
   - 愿意帮助的区域
   - 交通方式
   - 紧急联系人信息（必填）
   - 之前经验（可选）
   - 支持文件（可选）
4. 同意条款和条件
5. 点击"Submit Application"按钮
6. 检查是否成功提交并跳转到待处理页面

**预期结果**: ✅ 申请成功提交，显示待处理状态

**注意事项**:
- 表单现在使用正确的HTML表单结构
- 提交按钮有正确的type="submit"属性
- 必填字段有required属性
- 表单提交时会显示处理状态
- **已修复**: `user_id` 字段现在会正确设置，不会再出现数据库错误

---

### 4. 社交分享积分测试

**测试目标**: 验证分享失踪人员案例到社交媒体时获得1积分

**步骤**:
1. 登录用户账户
2. 访问任意失踪人员详情页面
3. 点击分享图标（铃铛图标）
4. 在弹出的分享模态框中，点击任意社交媒体图标（Facebook、Twitter、WhatsApp、Instagram）
5. 系统会自动记录分享并显示积分获得提示
6. 检查积分是否增加1分
7. 重复分享到同一平台，应该不会再次获得积分

**预期结果**: ✅ 每次分享获得1积分（每个平台只能获得一次）

**注意事项**:
- 分享功能现在会调用后端API记录分享
- 每个平台（Facebook、Twitter、WhatsApp、Instagram）只能获得一次积分
- 重复分享到同一平台不会获得额外积分
- 分享后会显示成功提示和获得的积分数量

---

### 5. 奖励兑换积分测试

**测试目标**: 验证兑换奖励时正确扣除积分

**步骤**:
1. 确保用户有足够积分（如100分）
2. 访问奖励页面
3. 选择一个需要20积分的奖励进行兑换
4. 完成兑换流程
5. 检查积分是否减少20分

**预期结果**: ✅ 兑换奖励后积分正确扣除

---

### 6. 积分历史记录测试

**测试目标**: 验证所有积分变动都有详细记录

**步骤**:
1. 在用户资料页面点击"View History"
2. 检查积分历史记录是否包含：
   - 注册奖励
   - 目击报告批准
   - 社区项目完成
   - 社交分享
   - 奖励兑换

**预期结果**: ✅ 所有积分变动都有详细记录

---

### 7. 积分通知测试

**测试目标**: 验证每次获得积分时都会收到通知

**步骤**:
1. 完成上述所有积分获得行为
2. 检查通知铃铛图标是否有未读通知
3. 点击通知铃铛查看通知列表
4. 验证是否包含以下通知：
   - 注册时的欢迎通知
   - 每次获得积分的通知

**预期结果**: ✅ 每次获得积分都会收到相应的通知

---

### 4.4. 项目状态回滚测试

**测试目标**: 验证当管理员将项目状态从 `completed` 改回其他状态时，积分会被正确扣除

**步骤**:
1. 确保有一个已完成的社区项目
2. 确保有志愿者已获得该项目积分
3. 以管理员身份登录
4. 访问 `/admin/community-projects`
5. 找到已完成的项目
6. 将状态从 `completed` 改为 `active` 或其他状态
7. 检查志愿者的积分是否被扣除
8. 检查是否收到积分扣除通知

**预期结果**: ✅ 积分被正确扣除，用户收到通知

**自动化测试**:
```bash
php artisan test:project-status-rollback
```

**注意事项**:
- 只有从 `completed` 状态改为其他状态时才会扣除积分
- 从其他状态改为 `completed` 时会正常发放积分
- 积分扣除会创建交易记录
- 用户会收到积分扣除通知
- 系统会记录状态变更日志

---

## 🔧 积分系统配置

### 积分奖励标准

| 行为 | 积分奖励 | 说明 |
|------|----------|------|
| 用户注册 | +10 | 一次性奖励 |
| 目击报告被批准 | +10 | 需要管理员批准 |
| 完成社区项目 | 项目设定 | 根据项目配置 |
| 社交分享 | +1 | 每个平台一次 |
| 兑换奖励 | -积分 | 根据奖励价格 |

### 通知功能

每次用户获得积分时，系统会自动发送通知：

| 积分行为 | 通知类型 | 通知内容 |
|----------|----------|----------|
| 用户注册 | 欢迎通知 + 积分通知 | 欢迎消息 + "You've earned 10 points for account registration" |
| 目击报告被批准 | 积分通知 | "You've earned 10 points for submitting an approved sighting report" |
| 完成社区项目 | 积分通知 | "You've earned X points for completing a community project" |
| 社交分享 | 积分通知 | "You've earned 1 points for sharing on social media" |

### 数据库表结构

- `user_points`: 用户积分余额
- `point_transactions`: 积分交易历史
- `social_shares`: 社交分享记录
- `user_rewards`: 用户奖励兑换记录
- `notifications`: 用户通知记录

## 🐛 常见问题排查

### 问题1: 注册后没有获得积分
**解决方案**:
1. 检查 `RegisteredUserController` 是否正确调用了 `PointsService`
2. 确认数据库连接正常
3. 检查 `user_points` 表是否存在

### 问题2: 提交报告后积分没有增加
**解决方案**:
1. 检查 `MissingReportController` 的 `store` 方法
2. 确认 `PointsService` 依赖注入正确
3. 查看错误日志

### 问题3: 社区项目完成后没有获得积分
**解决方案**:
1. 检查项目状态是否正确更新为"completed"
2. 确认志愿者申请状态为"approved"
3. 检查 `CommunityProjectController` 的 `updateStatus` 方法

### 问题4: 积分历史记录不完整
**解决方案**:
1. 检查 `point_transactions` 表是否有数据
2. 确认所有积分操作都调用了 `PointsService`
3. 检查事务是否正常提交

## 📊 测试结果记录

| 测试项目 | 状态 | 备注 |
|----------|------|------|
| 用户注册积分 | ✅/❌ | |
| 目击报告积分 | ✅/❌ | |
| 社区项目积分 | ✅/❌ | |
| 社交分享积分 | ✅/❌ | |
| 奖励兑换积分 | ✅/❌ | |
| 积分历史记录 | ✅/❌ | |
| 积分通知功能 | ✅/❌ | |

## 🎉 测试完成

如果所有测试都通过，说明积分系统工作正常！

如果发现问题，请：
1. 检查错误日志
2. 验证数据库连接
3. 确认所有依赖注入正确
4. 联系开发团队

---

**最后更新**: 2025年8月26日
**版本**: 1.0
